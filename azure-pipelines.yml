# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'
  imageName: 'selconyt/solar-system'
  trivyCacheDir: '$(Pipeline.Workspace)/.trivy-cache'   # Ù…Ø³Ø§Ø± Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
  trivyBinDir: '$(Pipeline.Workspace)/.trivy-bin'       # Ù…Ø³Ø§Ø± Ø§Ù„Ø¨Ø§ÙŠÙ†Ø§Ø±ÙŠ

stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: Default
    steps:
    # ============ 1. ØªØ®Ø¨Ø¦Ø© Ø§Ù„Ø¨Ø§ÙŠÙ†Ø§Ø±ÙŠ ============
    - task: Cache@2
      displayName: 'Cache Trivy binary'
      inputs:
        key: 'trivy-bin | "$(Agent.OS)" | v0.69.0'
        path: '$(trivyBinDir)'
        restoreKeys: |
          trivy-bin | "$(Agent.OS)"

    # ============ 2. ØªØ®Ø¨Ø¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ============
    - task: Cache@2
      displayName: 'Cache Trivy vulnerability DB'
      inputs:
        key: 'trivy-db | "$(Agent.OS)" | "$(Date:yyyyMMdd)"'  # ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠ
        path: '$(trivyCacheDir)'
        restoreKeys: |
          trivy-db | "$(Agent.OS)"

    # ============ 3. Build Docker image ============
    - task: Docker@2
      displayName: 'Build Docker image'
      inputs:
        command: build
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        repository: $(imageName)
        tags: |
          $(tag)

    # ============ 4. Trivy Scan (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª) ============
    - script: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
        mkdir -p $(trivyBinDir) $(trivyCacheDir)
        
        # ØªØ«Ø¨ÙŠØª Trivy Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        if [ ! -f "$(trivyBinDir)/trivy" ]; then
          echo "ğŸ“¦ Installing Trivy v0.69.0..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b $(trivyBinDir) v0.69.0
        else
          echo "âœ… Trivy binary restored from cache"
        fi
        
        # ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ HTML
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o trivy-html.tpl
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        echo "ğŸ” Scanning image: $(imageName):$(tag)..."
        $(trivyBinDir)/trivy image \
          --cache-dir $(trivyCacheDir) \
          --severity HIGH,CRITICAL \
          --format template \
          --template "@trivy-html.tpl" \
          --output trivy-report.html \
          $(imageName):$(tag)
        
        echo "âœ… Scan completed successfully"
      displayName: 'Trivy scan & generate HTML report'
      env:
        TRIVY_CACHE_DIR: $(trivyCacheDir)  # Ø¨Ø¯ÙŠÙ„ Ù„Ù€ --cache-dir

    # ============ 5. Ù†Ø´Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ============
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Trivy HTML report'
      inputs:
        pathToPublish: trivy-report.html
        artifactName: trivy-report

    # ============ 6. Docker Login ============
    - task: Docker@2
      displayName: 'Docker Login'
      inputs:
        containerRegistry: 'Selcon-Docker-Hub'
        command: 'login'

    # ============ 7. Push to Docker Hub ============
    - task: Docker@2
      displayName: 'Push to Docker Hub'
      inputs:
        containerRegistry: 'Selcon-Docker-Hub'
        repository: $(imageName)
        command: 'push'
        tags: |
          $(tag)
